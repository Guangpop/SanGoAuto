<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŠæˆ²ç‹€æ…‹è¨ºæ–·å·¥å…·</title>
    <style>
        body { font-family: 'Courier New', monospace; margin: 20px; }
        .debug-section { border: 1px solid #ccc; margin: 10px 0; padding: 15px; }
        .status-good { color: green; font-weight: bold; }
        .status-bad { color: red; font-weight: bold; }
        .status-warning { color: orange; font-weight: bold; }
        pre { background: #f5f5f5; padding: 10px; overflow: auto; }
        button { padding: 10px 15px; margin: 5px; font-size: 14px; }
    </style>
</head>
<body>
    <h1>ğŸ” éŠæˆ²ç‹€æ…‹è¨ºæ–·å·¥å…·</h1>

    <div class="debug-section">
        <h2>å¿«é€Ÿè¨ºæ–·</h2>
        <button onclick="runDiagnostics()">é‹è¡Œè¨ºæ–·</button>
        <button onclick="forceStartGame()">å¼·åˆ¶å•Ÿå‹•éŠæˆ²</button>
        <button onclick="clearDebugOutput()">æ¸…é™¤è¼¸å‡º</button>
        <div id="diagnosis-output"></div>
    </div>

    <div class="debug-section">
        <h2>å¯¦æ™‚ç‹€æ…‹ç›£æ§</h2>
        <button onclick="startMonitoring()">é–‹å§‹ç›£æ§</button>
        <button onclick="stopMonitoring()">åœæ­¢ç›£æ§</button>
        <div id="monitoring-output"></div>
    </div>

    <!-- è¼‰å…¥éŠæˆ²æ–‡ä»¶ -->
    <script src="js/utils/helpers.js"></script>
    <script src="js/utils/logger.js"></script>
    <script src="js/core/skill-system.js"></script>
    <script src="js/core/battle-system.js"></script>
    <script src="js/core/event-system.js"></script>
    <script src="js/core/turn-manager.js"></script>
    <script src="js/core/game-engine.js"></script>
    <script src="js/ui/components/skill-ui.js"></script>
    <script src="js/ui/components/game-ui.js"></script>
    <script src="js/ui/components/event-log-ui.js"></script>
    <script src="js/ui/ui-manager.js"></script>

    <script>
        let monitoringInterval = null;

        function log(message, type = 'info') {
            const output = document.getElementById('diagnosis-output');
            const className = type === 'good' ? 'status-good' :
                             type === 'bad' ? 'status-bad' :
                             type === 'warning' ? 'status-warning' : '';

            const div = document.createElement('div');
            div.className = className;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            output.appendChild(div);
            output.scrollTop = output.scrollHeight;
        }

        function clearDebugOutput() {
            document.getElementById('diagnosis-output').innerHTML = '';
            document.getElementById('monitoring-output').innerHTML = '';
        }

        async function runDiagnostics() {
            log('=== é–‹å§‹éŠæˆ²ç‹€æ…‹è¨ºæ–· ===');

            // 1. æª¢æŸ¥å…¨å±€å°è±¡
            log('1. æª¢æŸ¥å…¨å±€å°è±¡...');

            if (typeof window.gameEngine === 'undefined') {
                log('âŒ gameEngine æœªå®šç¾©', 'bad');
                return;
            } else {
                log('âœ… gameEngine å·²è¼‰å…¥', 'good');
            }

            if (typeof window.uiManager === 'undefined') {
                log('âŒ uiManager æœªå®šç¾©', 'bad');
            } else {
                log('âœ… uiManager å·²è¼‰å…¥', 'good');
            }

            // 2. æª¢æŸ¥éŠæˆ²æ•¸æ“š
            log('2. æª¢æŸ¥éŠæˆ²æ•¸æ“š...');

            if (!window.gameEngine.gameData || !window.gameEngine.gameData.skills) {
                log('âŒ éŠæˆ²æ•¸æ“šæœªè¼‰å…¥', 'bad');
                log('   æç¤ºï¼šç­‰å¾…æ•¸æ“šè¼‰å…¥å®Œæˆ', 'warning');
                setTimeout(runDiagnostics, 2000);
                return;
            } else {
                log(`âœ… éŠæˆ²æ•¸æ“šå·²è¼‰å…¥ (${window.gameEngine.gameData.skills.length} å€‹æŠ€èƒ½)`, 'good');
            }

            // 3. æª¢æŸ¥éŠæˆ²ç‹€æ…‹
            log('3. æª¢æŸ¥éŠæˆ²ç‹€æ…‹...');

            if (!window.gameEngine.gameState) {
                log('âŒ gameState æœªåˆå§‹åŒ–', 'bad');
            } else {
                const status = window.gameEngine.gameState.status;
                const isRunning = window.gameEngine.isRunning;

                log(`ğŸ“Š éŠæˆ²ç‹€æ…‹: ${status}`, status === 'playing' ? 'good' : 'warning');
                log(`ğŸƒ éŠæˆ²é‹è¡Œ: ${isRunning}`, isRunning ? 'good' : 'warning');

                if (window.gameEngine.gameState.currentTurn !== undefined) {
                    log(`ğŸ”„ ç•¶å‰å›åˆ: ${window.gameEngine.gameState.currentTurn}`);
                }
            }

            // 4. æª¢æŸ¥æŠ€èƒ½ç³»çµ±
            log('4. æª¢æŸ¥æŠ€èƒ½ç³»çµ±...');

            if (window.gameEngine.skillSystem) {
                const skillSelection = window.gameEngine.skillSystem.skillSelection;
                if (skillSelection) {
                    log(`â­ æŠ€èƒ½é¸æ“‡é€²è¡Œä¸­ - ç¬¬${skillSelection.round}è¼ªï¼Œå‰©é¤˜${skillSelection.remainingStars}æ˜Ÿ`);
                    log(`ğŸ¯ å·²é¸æŠ€èƒ½: ${skillSelection.selectedSkills.length}å€‹`);
                    log(`ğŸ“‹ å¯é¸æŠ€èƒ½: ${skillSelection.availableSkills.length}å€‹`);
                } else {
                    log('ğŸ’¤ æŠ€èƒ½é¸æ“‡æœªå•Ÿå‹•');
                }
            }

            // 5. æª¢æŸ¥å›åˆç®¡ç†å™¨
            log('5. æª¢æŸ¥å›åˆç®¡ç†å™¨...');

            if (window.gameEngine.turnManager) {
                const hasGameLoop = !!window.gameEngine.turnManager.gameLoop;
                log(`â° éŠæˆ²å¾ªç’°: ${hasGameLoop ? 'é‹è¡Œä¸­' : 'æœªé‹è¡Œ'}`, hasGameLoop ? 'good' : 'warning');
            }

            // 6. æª¢æŸ¥UIç‹€æ…‹
            log('6. æª¢æŸ¥UIç‹€æ…‹...');

            if (window.uiManager) {
                log(`ğŸ–¼ï¸ ç•¶å‰è¢å¹•: ${window.uiManager.currentScreen}`);

                const skillElements = window.uiManager.elements.skillSelection;
                if (skillElements && skillElements.skipBtn) {
                    log('âœ… æŠ€èƒ½é¸æ“‡UIå…ƒç´ æ­£å¸¸');

                    // æª¢æŸ¥æŒ‰éˆ•äº‹ä»¶
                    const hasClickHandler = skillElements.skipBtn.onclick ||
                                          skillElements.skipBtn.addEventListener;
                    log(`ğŸ–±ï¸ è·³éæŒ‰éˆ•äº‹ä»¶: ${hasClickHandler ? 'å·²ç¶å®š' : 'æœªç¶å®š'}`,
                        hasClickHandler ? 'good' : 'bad');
                } else {
                    log('âŒ æŠ€èƒ½é¸æ“‡UIå…ƒç´ ç¼ºå¤±', 'bad');
                }
            }

            log('=== è¨ºæ–·å®Œæˆ ===');
        }

        function forceStartGame() {
            log('ğŸš€ å¼·åˆ¶å•Ÿå‹•éŠæˆ²æµç¨‹...');

            if (!window.gameEngine) {
                log('âŒ gameEngineä¸å­˜åœ¨ï¼Œç„¡æ³•å•Ÿå‹•', 'bad');
                return;
            }

            try {
                // å¦‚æœåœ¨æŠ€èƒ½é¸æ“‡éšæ®µï¼Œå¼·åˆ¶å®Œæˆ
                if (window.gameEngine.gameState.status === 'skill_selection') {
                    log('â­ï¸ å¼·åˆ¶å®ŒæˆæŠ€èƒ½é¸æ“‡...');

                    if (window.gameEngine.skillSystem && window.gameEngine.skillSystem.skillSelection) {
                        // è·³éå‰©é¤˜æ‰€æœ‰è¼ªæ¬¡
                        while (window.gameEngine.skillSystem.skillSelection.round <= 3) {
                            window.gameEngine.skillSystem.skipSkillRound();
                        }
                    } else {
                        // ç›´æ¥è¨­ç½®ç‹€æ…‹ä¸¦å•Ÿå‹•éŠæˆ²
                        window.gameEngine.gameState.status = 'playing';
                        window.gameEngine.turnManager.startMainGameLoop();
                    }

                    log('âœ… éŠæˆ²å¼·åˆ¶å•Ÿå‹•å®Œæˆ', 'good');
                } else if (window.gameEngine.gameState.status === 'playing') {
                    if (!window.gameEngine.isRunning) {
                        log('ğŸ”„ é‡æ–°å•Ÿå‹•éŠæˆ²å¾ªç’°...');
                        window.gameEngine.turnManager.startMainGameLoop();
                    } else {
                        log('â„¹ï¸ éŠæˆ²å·²ç¶“åœ¨é‹è¡Œä¸­', 'good');
                    }
                } else {
                    log(`âš ï¸ éŠæˆ²ç‹€æ…‹ç•°å¸¸: ${window.gameEngine.gameState.status}`, 'warning');
                }
            } catch (error) {
                log(`âŒ å•Ÿå‹•å¤±æ•—: ${error.message}`, 'bad');
                console.error('å¼·åˆ¶å•Ÿå‹•éŠæˆ²éŒ¯èª¤:', error);
            }
        }

        function startMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
            }

            const output = document.getElementById('monitoring-output');
            output.innerHTML = '<h3>å¯¦æ™‚ç›£æ§ä¸­...</h3>';

            monitoringInterval = setInterval(() => {
                if (!window.gameEngine) return;

                const status = window.gameEngine.gameState ? window.gameEngine.gameState.status : 'undefined';
                const isRunning = window.gameEngine.isRunning;
                const currentTurn = window.gameEngine.gameState ? window.gameEngine.gameState.currentTurn : 0;
                const hasGameLoop = window.gameEngine.turnManager ? !!window.gameEngine.turnManager.gameLoop : false;

                output.innerHTML = `
                    <h3>å¯¦æ™‚ç›£æ§ - ${new Date().toLocaleTimeString()}</h3>
                    <pre>
éŠæˆ²ç‹€æ…‹: ${status}
éŠæˆ²é‹è¡Œ: ${isRunning}
ç•¶å‰å›åˆ: ${currentTurn}
éŠæˆ²å¾ªç’°: ${hasGameLoop ? 'é‹è¡Œä¸­' : 'åœæ­¢'}
æŠ€èƒ½é¸æ“‡: ${window.gameEngine.skillSystem && window.gameEngine.skillSystem.skillSelection ?
    `ç¬¬${window.gameEngine.skillSystem.skillSelection.round}è¼ª` : 'æœªå•Ÿå‹•'}
                    </pre>
                `;
            }, 1000);

            log('ğŸ“¡ é–‹å§‹å¯¦æ™‚ç›£æ§...', 'good');
        }

        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
                document.getElementById('monitoring-output').innerHTML = '<p>ç›£æ§å·²åœæ­¢</p>';
                log('ğŸ›‘ åœæ­¢å¯¦æ™‚ç›£æ§', 'warning');
            }
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œè‡ªå‹•é‹è¡Œè¨ºæ–·
        window.addEventListener('load', () => {
            setTimeout(runDiagnostics, 1000);
        });
    </script>
</body>
</html>