<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿®å¾©äº‹ä»¶UIé¡¯ç¤º</title>

    <!-- CSS -->
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/game-layout.css">

    <style>
        body { background: #111; color: white; }

        .fix-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fix-panel {
            background: #222;
            color: lime;
            padding: 30px;
            border-radius: 10px;
            border: 2px solid lime;
            max-width: 600px;
            font-family: monospace;
        }

        .fix-panel button {
            display: block;
            width: 100%;
            margin: 10px 0;
            padding: 12px;
            background: #333;
            color: lime;
            border: 1px solid lime;
            border-radius: 5px;
            cursor: pointer;
            font-family: monospace;
            font-size: 14px;
        }

        .fix-panel button:hover {
            background: #444;
        }

        .fix-panel button.success {
            background: #050;
            border-color: #0f0;
        }

        .fix-panel button.error {
            background: #500;
            border-color: #f00;
        }

        .status {
            margin: 15px 0;
            padding: 10px;
            background: #111;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 12px;
        }

        #event-log {
            border: 3px solid yellow !important;
            background: rgba(255, 255, 255, 1) !important;
            color: black !important;
        }
    </style>
</head>
<body>
    <!-- éŠæˆ²ç•«é¢ -->
    <div id="app">
        <main id="main-area">
            <div id="phaser-root" class="phaser-block">
                <div style="padding: 200px 50px; text-align: center;">
                    <h2>äº‹ä»¶UIä¿®å¾©å·¥å…·</h2>
                    <p>é»æ“Šä¸­å¤®çš„ä¿®å¾©æŒ‰éˆ•è§£æ±ºäº‹ä»¶é¡¯ç¤ºå•é¡Œ</p>
                </div>
            </div>

            <div id="ui-overlay" class="ui-block">
                <aside id="event-log" class="overlay left-bottom" aria-live="polite">
                    <div class="event-item">ç­‰å¾…ä¿®å¾©...</div>
                </aside>

                <div id="bottom-tabs" class="overlay bottom-tabs">
                    <div class="tab-buttons">
                        <button data-tab="fix" class="tab-btn active">ä¿®å¾©</button>
                    </div>
                    <div id="tab-content" class="tab-content">
                        äº‹ä»¶UIä¿®å¾©å·¥å…·
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ä¿®å¾©é¢æ¿ -->
    <div class="fix-overlay" id="fix-overlay">
        <div class="fix-panel">
            <h2>ğŸ”§ äº‹ä»¶UIä¿®å¾©å·¥å…·</h2>
            <p>è§£æ±ºäº‹ä»¶æœ‰ç”¢ç”Ÿä½†UIä¸é¡¯ç¤ºçš„å•é¡Œ</p>

            <button onclick="runDiagnostic()" id="btn-diagnostic">ğŸ” 1. åŸ·è¡Œè¨ºæ–·</button>
            <button onclick="fixEventFlow()" id="btn-fix">ğŸ› ï¸ 2. ä¿®å¾©äº‹ä»¶æµ</button>
            <button onclick="testEvents()" id="btn-test">ğŸ§ª 3. æ¸¬è©¦äº‹ä»¶</button>
            <button onclick="simulateGame()" id="btn-simulate">ğŸ® 4. æ¨¡æ“¬éŠæˆ²</button>
            <button onclick="closePanel()" id="btn-close">âœ… ä¿®å¾©å®Œæˆ</button>

            <div class="status" id="status-log">
                é»æ“Š"åŸ·è¡Œè¨ºæ–·"é–‹å§‹...
            </div>
        </div>
    </div>

    <!-- è¼‰å…¥éŠæˆ²è…³æœ¬ -->
    <script src="js/utils/helpers.js"></script>
    <script src="js/utils/logger.js"></script>
    <script src="js/ui/game-api.js"></script>
    <script src="js/core/skill-system.js"></script>
    <script src="js/core/battle-system.js"></script>
    <script src="js/core/event-system.js"></script>
    <script src="js/core/turn-manager.js"></script>
    <script src="js/core/game-engine.js"></script>

    <script>
        const statusLog = document.getElementById('status-log');

        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const colors = { info: 'lime', error: 'red', success: 'green', warning: 'yellow' };
            const entry = document.createElement('div');
            entry.style.color = colors[type] || 'lime';
            entry.textContent = `[${time}] ${message}`;
            statusLog.appendChild(entry);
            statusLog.scrollTop = statusLog.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function setButtonState(btnId, state) {
            const btn = document.getElementById(btnId);
            btn.className = state; // success, error, or default
        }

        function runDiagnostic() {
            log('ğŸ” é–‹å§‹è¨ºæ–·...', 'info');

            // æª¢æŸ¥ gameAPI
            if (window.gameAPI) {
                log('âœ… gameAPI å­˜åœ¨', 'success');
                setButtonState('btn-diagnostic', 'success');

                // æª¢æŸ¥ DOM å…ƒç´ 
                const eventLog = document.getElementById('event-log');
                if (eventLog) {
                    log('âœ… event-log å…ƒç´ å­˜åœ¨', 'success');
                    log(`   ä½ç½®: ${eventLog.getBoundingClientRect().left}, ${eventLog.getBoundingClientRect().top}`, 'info');
                    log(`   å¤§å°: ${eventLog.offsetWidth} x ${eventLog.offsetHeight}`, 'info');
                    log(`   å­å…ƒç´ : ${eventLog.children.length}`, 'info');
                } else {
                    log('âŒ event-log å…ƒç´ ä¸å­˜åœ¨', 'error');
                    setButtonState('btn-diagnostic', 'error');
                }

                // æª¢æŸ¥ gameLogger
                if (window.gameLogger) {
                    log('âœ… gameLogger å­˜åœ¨', 'success');
                } else {
                    log('âŒ gameLogger ä¸å­˜åœ¨', 'error');
                    setButtonState('btn-diagnostic', 'error');
                }

            } else {
                log('âŒ gameAPI ä¸å­˜åœ¨', 'error');
                setButtonState('btn-diagnostic', 'error');
            }

            log('ğŸ“‹ è¨ºæ–·å®Œæˆ', 'info');
        }

        function fixEventFlow() {
            log('ğŸ› ï¸ é–‹å§‹ä¿®å¾©äº‹ä»¶æµ...', 'info');

            try {
                // 1. å¼·åˆ¶é‡æ–°åˆå§‹åŒ– gameAPI
                if (window.gameAPI) {
                    window.gameAPI.init();
                    log('âœ… gameAPI é‡æ–°åˆå§‹åŒ–', 'success');

                    if (window.gameAPI.forceReinit) {
                        window.gameAPI.forceReinit();
                        log('âœ… gameAPI å¼·åˆ¶é‡æ–°åˆå§‹åŒ–', 'success');
                    }
                }

                // 2. æ””æˆªå’Œä¿®å¾©äº‹ä»¶æµ
                const originalGameLoggerGame = window.gameLogger.game;
                window.gameLogger.game = function(category, message, data) {
                    log(`ğŸ“¥ æ””æˆªåˆ°äº‹ä»¶: ${category} - ${message}`, 'info');

                    // èª¿ç”¨åŸå§‹æ–¹æ³•
                    originalGameLoggerGame.call(this, category, message, data);

                    // å¼·åˆ¶ç™¼é€åˆ°UIï¼ˆå‚™ç”¨æ©Ÿåˆ¶ï¼‰
                    setTimeout(() => {
                        if (window.gameAPI && window.gameAPI.pushEventLog) {
                            const formattedMessage = `${category}: ${message}`;
                            window.gameAPI.pushEventLog(formattedMessage, { type: 'info' });
                            log(`ğŸ“¤ å¼·åˆ¶ç™¼é€åˆ°UI: ${formattedMessage}`, 'success');
                        }
                    }, 100);
                };

                log('âœ… äº‹ä»¶æµæ””æˆªå™¨å·²å®‰è£', 'success');
                setButtonState('btn-fix', 'success');

            } catch (error) {
                log(`âŒ ä¿®å¾©å¤±æ•—: ${error.message}`, 'error');
                setButtonState('btn-fix', 'error');
            }
        }

        function testEvents() {
            log('ğŸ§ª é–‹å§‹æ¸¬è©¦äº‹ä»¶...', 'info');

            const testEvents = [
                { category: 'æ¸¬è©¦', message: 'é€™æ˜¯æ¸¬è©¦äº‹ä»¶ 1' },
                { category: 'ç³»çµ±', message: 'é€™æ˜¯æ¸¬è©¦äº‹ä»¶ 2' },
                { category: 'æˆ°é¬¥', message: 'é€™æ˜¯æ¸¬è©¦äº‹ä»¶ 3' }
            ];

            testEvents.forEach((event, index) => {
                setTimeout(() => {
                    if (window.gameLogger) {
                        window.gameLogger.game(event.category, event.message);
                        log(`ğŸ“ ç™¼é€æ¸¬è©¦äº‹ä»¶ ${index + 1}`, 'info');
                    }
                }, index * 1000);
            });

            setButtonState('btn-test', 'success');
            log('âœ… æ¸¬è©¦äº‹ä»¶å·²ç™¼é€', 'success');
        }

        function simulateGame() {
            log('ğŸ® æ¨¡æ“¬éŠæˆ²äº‹ä»¶...', 'info');

            // å‰µå»ºç°¡å–®çš„éŠæˆ²å¼•æ“ç‹€æ…‹
            if (!window.gameEngine) {
                window.gameEngine = {
                    gameState: {
                        player: {
                            name: 'æ¸¬è©¦ç©å®¶',
                            level: 1,
                            attributes: { strength: 20, intelligence: 15 },
                            gold: 500,
                            troops: 1000,
                            citiesControlled: 1
                        }
                    },
                    isRunning: true
                };
                log('âœ… å‰µå»ºæ¨¡æ“¬éŠæˆ²å¼•æ“', 'success');
            }

            // æ¨¡æ“¬éŠæˆ²äº‹ä»¶
            const gameEvents = [
                { category: 'å›åˆ', message: 'ç¬¬ 1 å›åˆé–‹å§‹' },
                { category: 'è³‡æº', message: 'ç”¢ç”Ÿ 50 é‡‘éŒ¢' },
                { category: 'äº‹ä»¶', message: 'ç™¼ç¾å•†éšŠ' },
                { category: 'æˆ°é¬¥', message: 'æ”»æ‰“è¨±éƒ½' },
                { category: 'å‹åˆ©', message: 'æˆ°é¬¥å‹åˆ©ï¼' }
            ];

            gameEvents.forEach((event, index) => {
                setTimeout(() => {
                    window.gameLogger.game(event.category, event.message);
                    log(`ğŸ¯ éŠæˆ²äº‹ä»¶: ${event.category} - ${event.message}`, 'success');
                }, index * 800);
            });

            setButtonState('btn-simulate', 'success');
            log('âœ… éŠæˆ²äº‹ä»¶æ¨¡æ“¬å·²å•Ÿå‹•', 'success');
        }

        function closePanel() {
            document.getElementById('fix-overlay').style.display = 'none';
            log('âœ… ä¿®å¾©å®Œæˆï¼Œé¢æ¿å·²é—œé–‰', 'success');

            // æŒçºŒç›£æ§äº‹ä»¶
            setInterval(() => {
                if (window.gameLogger && Math.random() < 0.3) {
                    const randomEvents = [
                        'è‡ªå‹•äº‹ä»¶ï¼šæ”¶é›†ç¨…æ”¶',
                        'è‡ªå‹•äº‹ä»¶ï¼šè¨“ç·´å£«å…µ',
                        'è‡ªå‹•äº‹ä»¶ï¼šæ¢ç´¢é ˜åœŸ'
                    ];
                    const event = randomEvents[Math.floor(Math.random() * randomEvents.length)];
                    window.gameLogger.game('è‡ªå‹•', event);
                }
            }, 3000);
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•åŸ·è¡Œ
        window.addEventListener('load', () => {
            log('ğŸŒŸ äº‹ä»¶UIä¿®å¾©å·¥å…·å·²è¼‰å…¥', 'success');

            setTimeout(() => {
                log('ğŸ¤– 3ç§’å¾Œè‡ªå‹•é–‹å§‹ä¿®å¾©...', 'info');
                setTimeout(() => {
                    runDiagnostic();
                    setTimeout(() => {
                        fixEventFlow();
                        setTimeout(() => {
                            testEvents();
                        }, 1000);
                    }, 1000);
                }, 3000);
            }, 1000);
        });
    </script>
</body>
</html>