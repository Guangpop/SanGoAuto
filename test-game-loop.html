<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŠæˆ²å¾ªç’°æ¸¬è©¦</title>

    <!-- CSS -->
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/game-layout.css">

    <style>
        body {
            background: #1a1a1a;
            color: white;
        }

        .test-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            color: black;
            padding: 20px;
            border-radius: 8px;
            z-index: 100;
            max-width: 400px;
        }

        .test-panel button {
            display: block;
            width: 100%;
            margin: 5px 0;
            padding: 8px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .status {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        #event-log {
            border: 2px solid lime !important;
            background: rgba(255, 255, 255, 1) !important;
        }

        .event-item {
            background: #e7f3ff;
            margin: 3px 0;
            padding: 6px;
            border-radius: 4px;
            border-left: 4px solid #007bff;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <!-- ç°¡åŒ–çš„éŠæˆ²ç•«é¢çµæ§‹ -->
    <div id="app">
        <main id="main-area">
            <div id="phaser-root" class="phaser-block">
                <div style="color: white; text-align: center; padding-top: 200px;">
                    <h2>éŠæˆ²å¾ªç’°æ¸¬è©¦</h2>
                    <p>æª¢æŸ¥äº‹ä»¶æ˜¯å¦èƒ½æ­£å¸¸å¾éŠæˆ²å¼•æ“å‚³åˆ°UI</p>
                </div>
            </div>

            <div id="ui-overlay" class="ui-block">
                <!-- äº‹ä»¶æ—¥èªŒ -->
                <aside id="event-log" class="overlay left-bottom" aria-live="polite">
                    <div class="event-item">ç­‰å¾…éŠæˆ²å¼•æ“å•Ÿå‹•...</div>
                </aside>

                <!-- åº•éƒ¨ Tab -->
                <div id="bottom-tabs" class="overlay bottom-tabs">
                    <div class="tab-buttons">
                        <button data-tab="test" class="tab-btn active">æ¸¬è©¦</button>
                    </div>
                    <div id="tab-content" class="tab-content">
                        éŠæˆ²å¾ªç’°æ¸¬è©¦ä¸­...
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- æ¸¬è©¦æ§åˆ¶é¢æ¿ -->
    <div class="test-panel">
        <h3>ğŸ”„ éŠæˆ²å¾ªç’°æ¸¬è©¦</h3>
        <button onclick="initializeGame()">ğŸš€ åˆå§‹åŒ–éŠæˆ²å¼•æ“</button>
        <button onclick="startGameLoop()">â–¶ï¸ å•Ÿå‹•éŠæˆ²å¾ªç’°</button>
        <button onclick="forceGameTurn()">âš¡ å¼·åˆ¶åŸ·è¡Œä¸€è¼ª</button>
        <button onclick="testGameLogger()">ğŸ“ æ¸¬è©¦éŠæˆ²æ—¥èªŒ</button>
        <button onclick="simulateRealGame()">ğŸ® æ¨¡æ“¬çœŸå¯¦éŠæˆ²</button>
        <button onclick="checkStatus()">ğŸ” æª¢æŸ¥ç‹€æ…‹</button>
        <div class="status" id="test-status">
            æº–å‚™æ¸¬è©¦éŠæˆ²å¾ªç’°...
        </div>
    </div>

    <!-- è¼‰å…¥éŠæˆ²è…³æœ¬ -->
    <script src="js/utils/helpers.js"></script>
    <script src="js/utils/logger.js"></script>
    <script src="js/ui/game-api.js"></script>
    <script src="js/core/skill-system.js"></script>
    <script src="js/core/battle-system.js"></script>
    <script src="js/core/event-system.js"></script>
    <script src="js/core/turn-manager.js"></script>
    <script src="js/core/game-engine.js"></script>

    <script>
        const testStatus = document.getElementById('test-status');

        function addStatus(message) {
            const item = document.createElement('div');
            item.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            testStatus.appendChild(item);
            testStatus.scrollTop = testStatus.scrollHeight;
            console.log('æ¸¬è©¦:', message);
        }

        function initializeGame() {
            addStatus('ğŸš€ åˆå§‹åŒ–éŠæˆ²å¼•æ“...');

            try {
                // ç¢ºä¿ gameAPI åˆå§‹åŒ–
                if (window.gameAPI) {
                    window.gameAPI.init();
                    addStatus('âœ… gameAPI å·²åˆå§‹åŒ–');
                }

                // å‰µå»ºéŠæˆ²å¼•æ“
                if (!window.gameEngine) {
                    window.gameEngine = new GameEngine();
                    addStatus('âœ… éŠæˆ²å¼•æ“å·²å‰µå»º');
                }

                // ç­‰å¾…æ•¸æ“šè¼‰å…¥
                const checkData = () => {
                    if (window.gameEngine.dataReady) {
                        addStatus('âœ… éŠæˆ²æ•¸æ“šå·²è¼‰å…¥');

                        // å‰µå»ºéŠæˆ²ç‹€æ…‹
                        window.gameEngine.gameState = window.gameEngine.createInitialGameState();
                        window.gameEngine.gameState.status = 'playing';
                        window.gameEngine.isRunning = true;

                        addStatus('âœ… éŠæˆ²ç‹€æ…‹å·²å‰µå»º');
                        addStatus(`ğŸ“Š ç©å®¶æ•¸æ“š: é‡‘éŒ¢=${window.gameEngine.gameState.player.gold}, å…µåŠ›=${window.gameEngine.gameState.player.troops}`);

                    } else {
                        addStatus('â³ ç­‰å¾…éŠæˆ²æ•¸æ“šè¼‰å…¥...');
                        setTimeout(checkData, 500);
                    }
                };

                checkData();

            } catch (error) {
                addStatus('âŒ åˆå§‹åŒ–å¤±æ•—: ' + error.message);
            }
        }

        function startGameLoop() {
            addStatus('â–¶ï¸ å•Ÿå‹•éŠæˆ²ä¸»å¾ªç’°...');

            if (!window.gameEngine || !window.gameEngine.gameState) {
                addStatus('âŒ è«‹å…ˆåˆå§‹åŒ–éŠæˆ²å¼•æ“');
                return;
            }

            try {
                window.gameEngine.turnManager.startMainGameLoop();
                addStatus('âœ… éŠæˆ²å¾ªç’°å·²å•Ÿå‹•');
                addStatus('â° ç­‰å¾…ç¬¬ä¸€è¼ªäº‹ä»¶...');

            } catch (error) {
                addStatus('âŒ å•Ÿå‹•å¤±æ•—: ' + error.message);
            }
        }

        function forceGameTurn() {
            addStatus('âš¡ å¼·åˆ¶åŸ·è¡Œä¸€å€‹éŠæˆ²è¼ªæ¬¡...');

            if (!window.gameEngine || !window.gameEngine.turnManager) {
                addStatus('âŒ éŠæˆ²å¼•æ“æœªæº–å‚™å¥½');
                return;
            }

            try {
                window.gameEngine.turnManager.executeGameTurn();
                addStatus('âœ… éŠæˆ²è¼ªæ¬¡å·²åŸ·è¡Œ');

            } catch (error) {
                addStatus('âŒ åŸ·è¡Œå¤±æ•—: ' + error.message);
            }
        }

        function testGameLogger() {
            addStatus('ğŸ“ æ¸¬è©¦éŠæˆ²æ—¥èªŒç³»çµ±...');

            if (!window.gameLogger) {
                addStatus('âŒ gameLogger ä¸å­˜åœ¨');
                return;
            }

            // æ¸¬è©¦ä¸åŒé¡å‹çš„æ—¥èªŒ
            gameLogger.game('æ¸¬è©¦', 'é€™æ˜¯ä¸€å€‹æ¸¬è©¦äº‹ä»¶');
            gameLogger.game('æˆ°é¬¥', 'æ¨¡æ“¬æˆ°é¬¥é–‹å§‹');
            gameLogger.game('è³‡æº', 'ç²å¾— 100 é‡‘éŒ¢');

            addStatus('âœ… æ¸¬è©¦äº‹ä»¶å·²ç™¼é€');

            // æ¸¬è©¦æ‰¹é‡äº‹ä»¶
            const testMessages = [
                { category: 'å›åˆ', message: 'ç¬¬ 1 å›åˆé–‹å§‹' },
                { category: 'è³‡æº', message: 'ç”¢ç”Ÿ 50 é‡‘éŒ¢' },
                { category: 'äº‹ä»¶', message: 'ç™¼ç¾æ–°çš„å•†éšŠ' },
                { category: 'æˆ°é¬¥', message: 'æ”»æ‰“é„°è¿‘åŸæ± ' }
            ];

            gameLogger.delayedLogBatch(testMessages, 500, 800);
            addStatus('âœ… æ‰¹é‡äº‹ä»¶å·²ç™¼é€ï¼ˆé–“éš”0.8ç§’ï¼‰');
        }

        function simulateRealGame() {
            addStatus('ğŸ® æ¨¡æ“¬çœŸå¯¦éŠæˆ²æµç¨‹...');

            // å…ˆåˆå§‹åŒ–
            initializeGame();

            setTimeout(() => {
                // ç„¶å¾Œå•Ÿå‹•å¾ªç’°
                startGameLoop();

                // å®šæœŸåŸ·è¡Œè¼ªæ¬¡
                let turnCount = 0;
                const turnInterval = setInterval(() => {
                    turnCount++;
                    addStatus(`ğŸ”„ åŸ·è¡Œç¬¬ ${turnCount} è¼ª...`);
                    forceGameTurn();

                    if (turnCount >= 5) {
                        clearInterval(turnInterval);
                        addStatus('âœ… æ¨¡æ“¬å®Œæˆï¼ˆ5è¼ªï¼‰');
                    }
                }, 3000);

            }, 2000);
        }

        function checkStatus() {
            addStatus('ğŸ” æª¢æŸ¥ç³»çµ±ç‹€æ…‹...');

            addStatus(`gameEngine: ${!!window.gameEngine}`);
            addStatus(`gameLogger: ${!!window.gameLogger}`);
            addStatus(`gameAPI: ${!!window.gameAPI}`);

            if (window.gameEngine) {
                addStatus(`æ•¸æ“šæº–å‚™: ${window.gameEngine.dataReady}`);
                addStatus(`éŠæˆ²é‹è¡Œ: ${window.gameEngine.isRunning}`);
                if (window.gameEngine.gameState) {
                    addStatus(`éŠæˆ²ç‹€æ…‹: ${window.gameEngine.gameState.status}`);
                    addStatus(`ç•¶å‰å›åˆ: ${window.gameEngine.gameState.currentTurn}`);
                }
            }

            const eventLog = document.getElementById('event-log');
            if (eventLog) {
                addStatus(`äº‹ä»¶æ—¥èªŒå­å…ƒç´ : ${eventLog.children.length}`);
            }
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•åŸ·è¡Œ
        window.addEventListener('load', () => {
            addStatus('ğŸŒŸ éŠæˆ²å¾ªç’°æ¸¬è©¦é é¢å·²è¼‰å…¥');

            setTimeout(() => {
                addStatus('ğŸ¤– 5ç§’å¾Œè‡ªå‹•å•Ÿå‹•æ¸¬è©¦...');
                setTimeout(simulateRealGame, 5000);
            }, 1000);
        });
    </script>
</body>
</html>