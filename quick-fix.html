<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿«é€Ÿä¿®å¾© - ä¸‰åœ‹å¤©å‘½</title>

    <!-- CSS -->
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/animations.css">
    <link rel="stylesheet" href="css/game-layout.css">

    <style>
        .fix-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            background: rgba(255, 255, 255, 0.98);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            max-width: 350px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .fix-panel h3 {
            margin: 0 0 15px 0;
            color: #d73502;
            font-size: 18px;
        }

        .fix-panel button {
            display: block;
            width: 100%;
            margin-bottom: 8px;
            padding: 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .fix-panel button:hover {
            background: #0056b3;
        }

        .fix-panel button.success {
            background: #28a745;
        }

        .fix-panel button.error {
            background: #dc3545;
        }

        .fix-status {
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .status-item {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }

        .status-success { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        .status-info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <!-- éŠæˆ²ç•«é¢ -->
    <div id="game-screen" class="screen active">
        <div id="app">
            <!-- é ‚éƒ¨è³‡è¨Šæ¬„ -->
            <header id="top-bar" class="ui-block">
                <div id="player-name">ç©å®¶ Lv.<span id="player-level">1</span></div>
                <div id="stats">
                    <span class="stat">æ­¦åŠ›: <span id="stat-attack">0</span></span>
                    <span class="stat">æ™ºåŠ›: <span id="stat-skill">0</span></span>
                    <span class="stat">çµ±æ²»: <span id="stat-rule">0</span></span>
                    <span class="stat">æ”¿æ²»: <span id="stat-politics">0</span></span>
                    <span class="stat">é­…åŠ›: <span id="stat-charisma">0</span></span>
                </div>
                <div id="resources">
                    é‡‘éŒ¢: <span id="money">0</span> å…µåŠ›: <span id="troops">0</span> åŸæ± : <span id="cities">0</span>
                </div>
            </header>

            <!-- ä¸»å…§å®¹å€ -->
            <main id="main-area">
                <!-- Phaser å°ˆå±¬å®¹å™¨ -->
                <div id="phaser-root" class="phaser-block" aria-label="game-canvas"></div>

                <!-- UI Overlay -->
                <div id="ui-overlay" class="ui-block">
                    <!-- äº‹ä»¶æ—¥èªŒ -->
                    <aside id="event-log" class="overlay left-bottom" aria-live="polite">
                        <div class="event-item">ç³»çµ±åˆå§‹åŒ–ä¸­...</div>
                    </aside>

                    <!-- åº•éƒ¨ Tab ç³»çµ± -->
                    <div id="bottom-tabs" class="overlay bottom-tabs">
                        <div class="tab-buttons">
                            <button data-tab="generals" class="tab-btn active">æ­¦å°‡</button>
                            <button data-tab="cities" class="tab-btn">åŸæ± </button>
                            <button data-tab="gear" class="tab-btn">è£å‚™</button>
                        </div>
                        <div id="tab-content" class="tab-content">
                            <!-- å…§å®¹å°‡è‡ªå‹•è¼‰å…¥ -->
                        </div>
                    </div>
                </div>
            </main>

            <!-- æˆ°é¬¥ Modal -->
            <div id="battle-modal" class="modal hidden" role="dialog" aria-hidden="true">
                <div class="modal-content">
                    <div id="battle-header">æˆ°é¬¥æ¸¬è©¦</div>
                    <div id="battle-log">æˆ°é¬¥æ—¥èªŒ...</div>
                    <button id="battle-close">è¿”å›</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å¿«é€Ÿä¿®å¾©é¢æ¿ -->
    <div class="fix-panel">
        <h3>ğŸ”§ å¿«é€Ÿä¿®å¾©</h3>
        <button onclick="quickFix()">ğŸš€ ä¸€éµä¿®å¾©</button>
        <button onclick="simulateGame()">ğŸ® æ¨¡æ“¬å®Œæ•´éŠæˆ²</button>
        <button onclick="testUIComponents()">ğŸ” æ¸¬è©¦UIçµ„ä»¶</button>
        <button onclick="checkDataFlow()">ğŸ“Š æª¢æŸ¥æ•¸æ“šæµ</button>
        <button onclick="forceRefresh()">ğŸ”„ å¼·åˆ¶åˆ·æ–°</button>
        <div class="fix-status" id="fix-status">
            é»æ“ŠæŒ‰éˆ•é–‹å§‹è¨ºæ–·...
        </div>
    </div>

    <!-- è¼‰å…¥éŠæˆ²è…³æœ¬ -->
    <script src="js/utils/helpers.js"></script>
    <script src="js/utils/logger.js"></script>
    <script src="js/ui/game-api.js"></script>

    <script>
        const fixStatus = document.getElementById('fix-status');

        function addStatus(message, type = 'info') {
            const item = document.createElement('div');
            item.className = `status-item status-${type}`;
            item.textContent = message;
            fixStatus.appendChild(item);
            fixStatus.scrollTop = fixStatus.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearStatus() {
            fixStatus.innerHTML = '';
        }

        function quickFix() {
            clearStatus();
            addStatus('ğŸš€ é–‹å§‹å¿«é€Ÿä¿®å¾©...', 'info');

            // 1. ç¢ºä¿ gameAPI æ­£ç¢ºåˆå§‹åŒ–
            if (window.gameAPI) {
                addStatus('âœ… gameAPI å­˜åœ¨', 'success');
                window.gameAPI.init();
                addStatus('âœ… gameAPI å·²é‡æ–°åˆå§‹åŒ–', 'success');
            } else {
                addStatus('âŒ gameAPI ä¸å­˜åœ¨', 'error');
                return;
            }

            // 2. å‰µå»ºæ¨¡æ“¬éŠæˆ²ç‹€æ…‹
            window.gameEngine = {
                gameState: {
                    player: {
                        name: 'æ¸¬è©¦ç©å®¶',
                        level: 3,
                        attributes: {
                            strength: 35,
                            intelligence: 28,
                            leadership: 32,
                            politics: 25,
                            charisma: 40
                        },
                        gold: 1500,
                        troops: 2000,
                        citiesControlled: 2,
                        equipment: {
                            weapon: {
                                id: 'test_sword',
                                name: 'æ¸¬è©¦åŠ',
                                rarity: 'rare',
                                effects: 'æ­¦åŠ› +10'
                            }
                        }
                    },
                    cities: new Map([
                        ['start', { id: 'start', name: 'èµ·å§‹åŸ', faction: 'player' }],
                        ['enemy1', { id: 'enemy1', name: 'æ•µåŸ1', faction: 'enemy', canAttack: true }]
                    ]),
                    status: 'playing'
                },
                dataReady: true
            };

            addStatus('âœ… æ¨¡æ“¬éŠæˆ²å¼•æ“å·²å‰µå»º', 'success');

            // 3. æ›´æ–°UI
            setTimeout(() => {
                window.gameAPI.updatePlayerStats({
                    level: window.gameEngine.gameState.player.level,
                    money: window.gameEngine.gameState.player.gold,
                    troops: window.gameEngine.gameState.player.troops,
                    cities: window.gameEngine.gameState.player.citiesControlled,
                    stats: {
                        attack: window.gameEngine.gameState.player.attributes.strength,
                        intellect: window.gameEngine.gameState.player.attributes.intelligence,
                        rule: window.gameEngine.gameState.player.attributes.leadership,
                        politics: window.gameEngine.gameState.player.attributes.politics,
                        charisma: window.gameEngine.gameState.player.attributes.charisma
                    }
                });

                addStatus('âœ… ç©å®¶æ•¸æ“šå·²æ›´æ–°', 'success');

                // 4. æ·»åŠ äº‹ä»¶æ—¥èªŒ
                window.gameAPI.pushEventLog('ğŸ® å¿«é€Ÿä¿®å¾©å®Œæˆï¼', { type: 'info' });
                window.gameAPI.pushEventLog('ğŸ“Š æ‰€æœ‰æ•¸æ“šå·²è¼‰å…¥', { type: 'info' });
                window.gameAPI.pushEventLog('âš”ï¸ æº–å‚™é–‹å§‹éŠæˆ²', { type: 'info' });

                addStatus('âœ… äº‹ä»¶æ—¥èªŒå·²æ›´æ–°', 'success');

                // 5. åˆ·æ–°Tabå…§å®¹
                if (window.gameAPI.refreshUI) {
                    window.gameAPI.refreshUI();
                    addStatus('âœ… Tabå…§å®¹å·²åˆ·æ–°', 'success');
                }

                addStatus('ğŸ‰ ä¿®å¾©å®Œæˆï¼æª¢æŸ¥UIæ˜¯å¦é¡¯ç¤ºæ­£å¸¸', 'success');

            }, 500);
        }

        function simulateGame() {
            clearStatus();
            addStatus('ğŸ® é–‹å§‹æ¨¡æ“¬å®Œæ•´éŠæˆ²...', 'info');

            quickFix();

            setTimeout(() => {
                // æ¨¡æ“¬éŠæˆ²äº‹ä»¶
                const events = [
                    'ğŸ° å»ºç«‹æ ¹æ“šåœ°',
                    'ğŸ‘¥ æ‹›å‹Ÿå£«å…µ',
                    'ğŸ’° æ”¶é›†ç¨…æ”¶',
                    'âš”ï¸ ç™¼ç¾æ•µè»',
                    'ğŸ¯ æº–å‚™æ”»åŸ'
                ];

                events.forEach((event, index) => {
                    setTimeout(() => {
                        window.gameAPI.pushEventLog(event, { type: 'info' });
                    }, (index + 1) * 1000);
                });

                // æ¨¡æ“¬æˆ°é¬¥
                setTimeout(() => {
                    addStatus('âš”ï¸ é–‹å§‹æˆ°é¬¥æ¨¡æ“¬...', 'info');
                    window.gameAPI.enterBattleMode({
                        attacker: { name: 'ç©å®¶' },
                        defender: { name: 'æ•µè»' }
                    });

                    setTimeout(() => {
                        window.gameAPI.exitBattleMode({
                            winner: 'player',
                            capturedGenerals: [{ name: 'æ–°æ­¦å°‡' }],
                            loot: { gold: 200 }
                        });
                        addStatus('âœ… æˆ°é¬¥æ¨¡æ“¬å®Œæˆ', 'success');
                    }, 5000);

                }, events.length * 1000 + 2000);

            }, 1000);
        }

        function testUIComponents() {
            clearStatus();
            addStatus('ğŸ” æ¸¬è©¦UIçµ„ä»¶...', 'info');

            // æª¢æŸ¥DOMå…ƒç´ 
            const elements = [
                'player-level', 'stat-attack', 'money', 'troops', 'cities',
                'event-log', 'tab-content'
            ];

            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    addStatus(`âœ… ${id} å­˜åœ¨`, 'success');
                } else {
                    addStatus(`âŒ ${id} ä¸å­˜åœ¨`, 'error');
                }
            });

            // æ¸¬è©¦Tabåˆ‡æ›
            setTimeout(() => {
                const tabs = ['cities', 'gear', 'generals'];
                tabs.forEach((tab, index) => {
                    setTimeout(() => {
                        const btn = document.querySelector(`[data-tab="${tab}"]`);
                        if (btn) {
                            btn.click();
                            addStatus(`âœ… ${tab} Tab æ¸¬è©¦é€šé`, 'success');
                        } else {
                            addStatus(`âŒ ${tab} Tab ä¸å­˜åœ¨`, 'error');
                        }
                    }, index * 500);
                });
            }, 1000);
        }

        function checkDataFlow() {
            clearStatus();
            addStatus('ğŸ“Š æª¢æŸ¥æ•¸æ“šæµ...', 'info');

            addStatus(`gameAPI: ${!!window.gameAPI}`, window.gameAPI ? 'success' : 'error');
            addStatus(`gameEngine: ${!!window.gameEngine}`, window.gameEngine ? 'success' : 'error');

            if (window.gameEngine && window.gameEngine.gameState) {
                addStatus(`éŠæˆ²ç‹€æ…‹: ${window.gameEngine.gameState.status}`, 'success');
                addStatus(`ç©å®¶ç­‰ç´š: ${window.gameEngine.gameState.player.level}`, 'info');
                addStatus(`ç©å®¶é‡‘éŒ¢: ${window.gameEngine.gameState.player.gold}`, 'info');
            } else {
                addStatus('âŒ éŠæˆ²ç‹€æ…‹ä¸å­˜åœ¨', 'error');
            }
        }

        function forceRefresh() {
            clearStatus();
            addStatus('ğŸ”„ å¼·åˆ¶åˆ·æ–°æ‰€æœ‰çµ„ä»¶...', 'info');

            if (window.gameAPI) {
                if (window.gameAPI.init) {
                    window.gameAPI.init();
                    addStatus('âœ… gameAPI é‡æ–°åˆå§‹åŒ–', 'success');
                }

                if (window.gameAPI.refreshUI) {
                    window.gameAPI.refreshUI();
                    addStatus('âœ… UI å¼·åˆ¶åˆ·æ–°', 'success');
                }
            }

            // å¼·åˆ¶é¡¯ç¤ºä¸€äº›æ•¸æ“š
            setTimeout(() => {
                window.gameAPI.updatePlayerStats({
                    level: 1,
                    money: 200,
                    troops: 800,
                    cities: 1,
                    stats: {
                        attack: 10,
                        intellect: 10,
                        rule: 10,
                        politics: 10,
                        charisma: 10
                    }
                });

                window.gameAPI.pushEventLog('ğŸ”„ ç³»çµ±é‡ç½®å®Œæˆ', { type: 'info' });
                addStatus('âœ… å¼·åˆ¶åˆ·æ–°å®Œæˆ', 'success');
            }, 200);
        }

        // è‡ªå‹•å•Ÿå‹•
        window.addEventListener('load', () => {
            addStatus('ğŸŒŸ å¿«é€Ÿä¿®å¾©å·¥å…·å·²è¼‰å…¥', 'info');
            addStatus('ğŸ’¡ é»æ“Š"ä¸€éµä¿®å¾©"è§£æ±ºé¡¯ç¤ºå•é¡Œ', 'info');

            // ç­‰å¾…ä¸€ä¸‹å†è‡ªå‹•ä¿®å¾©
            setTimeout(() => {
                addStatus('â° 5ç§’å¾Œè‡ªå‹•é–‹å§‹ä¿®å¾©...', 'info');
                setTimeout(quickFix, 5000);
            }, 1000);
        });
    </script>
</body>
</html>