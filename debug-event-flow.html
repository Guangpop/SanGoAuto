<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº‹ä»¶æµç¨‹èª¿è©¦</title>

    <!-- CSS -->
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/game-layout.css">

    <style>
        body {
            background: #1a1a1a;
            color: white;
            font-family: monospace;
        }

        .debug-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: lime;
            padding: 20px;
            border-radius: 8px;
            z-index: 1000;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            border: 2px solid lime;
        }

        .debug-panel button {
            display: block;
            width: 100%;
            margin: 5px 0;
            padding: 8px;
            background: #333;
            color: lime;
            border: 1px solid lime;
            border-radius: 4px;
            cursor: pointer;
            font-family: monospace;
        }

        .debug-panel button:hover {
            background: #555;
        }

        .log {
            background: #000;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #333;
        }

        #event-log {
            border: 3px solid red !important;
            background: rgba(255, 255, 255, 1) !important;
            color: black !important;
        }

        .event-item {
            background: #f0f8ff;
            margin: 2px 0;
            padding: 4px;
            border-radius: 3px;
            border-left: 3px solid #007bff;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <!-- éŠæˆ²ç•«é¢ -->
    <div id="app">
        <main id="main-area">
            <div id="phaser-root" class="phaser-block">
                <div style="color: white; text-align: center; padding-top: 200px;">
                    <h2>äº‹ä»¶æµç¨‹èª¿è©¦</h2>
                    <p>æª¢æŸ¥äº‹ä»¶å¾ç”¢ç”Ÿåˆ°UIé¡¯ç¤ºçš„å®Œæ•´è·¯å¾‘</p>
                </div>
            </div>

            <div id="ui-overlay" class="ui-block">
                <!-- äº‹ä»¶æ—¥èªŒ -->
                <aside id="event-log" class="overlay left-bottom" aria-live="polite">
                    <div class="event-item">èª¿è©¦åˆå§‹åŒ–...</div>
                </aside>

                <!-- åº•éƒ¨ Tab -->
                <div id="bottom-tabs" class="overlay bottom-tabs">
                    <div class="tab-buttons">
                        <button data-tab="debug" class="tab-btn active">èª¿è©¦</button>
                    </div>
                    <div id="tab-content" class="tab-content">
                        äº‹ä»¶æµç¨‹èª¿è©¦ä¸­...
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- èª¿è©¦é¢æ¿ -->
    <div class="debug-panel">
        <h3>ğŸ” äº‹ä»¶æµç¨‹èª¿è©¦</h3>
        <button onclick="testDirectEventLog()">1. æ¸¬è©¦ç›´æ¥äº‹ä»¶æ—¥èªŒ</button>
        <button onclick="testGameAPI()">2. æ¸¬è©¦ gameAPI</button>
        <button onclick="testGameLogger()">3. æ¸¬è©¦ gameLogger</button>
        <button onclick="interceptEventFlow()">4. æ””æˆªäº‹ä»¶æµ</button>
        <button onclick="checkElements()">5. æª¢æŸ¥DOMå…ƒç´ </button>
        <button onclick="clearDebugLog()">æ¸…é™¤æ—¥èªŒ</button>

        <div class="log" id="debug-log"></div>
    </div>

    <!-- è¼‰å…¥éŠæˆ²è…³æœ¬ -->
    <script src="js/utils/helpers.js"></script>
    <script src="js/utils/logger.js"></script>
    <script src="js/ui/game-api.js"></script>

    <script>
        const debugLog = document.getElementById('debug-log');

        function log(message, color = 'lime') {
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.style.color = color;
            entry.textContent = `[${time}] ${message}`;
            debugLog.appendChild(entry);
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(`[DEBUG] ${message}`);
        }

        function clearDebugLog() {
            debugLog.innerHTML = '';
        }

        function testDirectEventLog() {
            log('=== æ¸¬è©¦ç›´æ¥æ·»åŠ åˆ°äº‹ä»¶æ—¥èªŒ ===', 'yellow');

            const eventLog = document.getElementById('event-log');
            if (!eventLog) {
                log('âŒ event-log å…ƒç´ ä¸å­˜åœ¨', 'red');
                return;
            }

            log('âœ… event-log å…ƒç´ å­˜åœ¨');

            const testItem = document.createElement('div');
            testItem.className = 'event-item';
            testItem.textContent = `ğŸ”§ ç›´æ¥æ·»åŠ æ¸¬è©¦ - ${new Date().toLocaleTimeString()}`;
            testItem.style.background = '#ffeb3b';

            eventLog.appendChild(testItem);
            log('âœ… ç›´æ¥æ·»åŠ æˆåŠŸ');
        }

        function testGameAPI() {
            log('=== æ¸¬è©¦ gameAPI ===', 'yellow');

            if (!window.gameAPI) {
                log('âŒ gameAPI ä¸å­˜åœ¨', 'red');
                return;
            }

            log('âœ… gameAPI å­˜åœ¨');

            if (typeof window.gameAPI.pushEventLog !== 'function') {
                log('âŒ pushEventLog æ–¹æ³•ä¸å­˜åœ¨', 'red');
                return;
            }

            log('âœ… pushEventLog æ–¹æ³•å­˜åœ¨');

            try {
                window.gameAPI.pushEventLog('ğŸ§ª gameAPI æ¸¬è©¦äº‹ä»¶', { type: 'info' });
                log('âœ… pushEventLog èª¿ç”¨æˆåŠŸ');
            } catch (error) {
                log(`âŒ pushEventLog èª¿ç”¨å¤±æ•—: ${error.message}`, 'red');
            }
        }

        function testGameLogger() {
            log('=== æ¸¬è©¦ gameLogger ===', 'yellow');

            if (!window.gameLogger) {
                log('âŒ gameLogger ä¸å­˜åœ¨', 'red');
                return;
            }

            log('âœ… gameLogger å­˜åœ¨');

            try {
                window.gameLogger.game('æ¸¬è©¦', 'ğŸ§ª gameLogger æ¸¬è©¦äº‹ä»¶');
                log('âœ… gameLogger.game èª¿ç”¨æˆåŠŸ');
            } catch (error) {
                log(`âŒ gameLogger.game èª¿ç”¨å¤±æ•—: ${error.message}`, 'red');
            }
        }

        function interceptEventFlow() {
            log('=== æ””æˆªäº‹ä»¶æµ ===', 'yellow');

            // æ””æˆª gameLogger.game
            if (window.gameLogger && window.gameLogger.game) {
                const originalGame = window.gameLogger.game;
                window.gameLogger.game = function(category, message, data) {
                    log(`ğŸ“¥ gameLogger.game: ${category} - ${message}`, 'cyan');
                    return originalGame.call(this, category, message, data);
                };
                log('âœ… gameLogger.game å·²æ””æˆª');
            }

            // æ””æˆª gameAPI.pushEventLog
            if (window.gameAPI && window.gameAPI.pushEventLog) {
                const originalPush = window.gameAPI.pushEventLog;
                window.gameAPI.pushEventLog = function(text, meta) {
                    log(`ğŸ“¤ gameAPI.pushEventLog: ${text}`, 'magenta');
                    return originalPush.call(this, text, meta);
                };
                log('âœ… gameAPI.pushEventLog å·²æ””æˆª');
            }

            // æ””æˆª DOM appendChild
            const eventLog = document.getElementById('event-log');
            if (eventLog) {
                const originalAppendChild = eventLog.appendChild;
                eventLog.appendChild = function(child) {
                    if (child.className && child.className.includes('event-item')) {
                        log(`ğŸ“‹ DOM appendChild: ${child.textContent}`, 'orange');
                    }
                    return originalAppendChild.call(this, child);
                };
                log('âœ… DOM appendChild å·²æ””æˆª');
            }

            log('ğŸ¯ ç¾åœ¨è§¸ç™¼ä¸€å€‹æ¸¬è©¦äº‹ä»¶...');
            window.gameLogger.game('æ””æˆªæ¸¬è©¦', 'é€™æ˜¯ä¸€å€‹æ¸¬è©¦äº‹ä»¶');
        }

        function checkElements() {
            log('=== æª¢æŸ¥DOMå…ƒç´  ===', 'yellow');

            const eventLog = document.getElementById('event-log');
            if (eventLog) {
                const rect = eventLog.getBoundingClientRect();
                log(`âœ… event-log: ${rect.width}x${rect.height} at (${rect.left}, ${rect.top})`);
                log(`   å­å…ƒç´ æ•¸é‡: ${eventLog.children.length}`);
                log(`   å¯è¦‹æ€§: ${getComputedStyle(eventLog).display}`);
                log(`   z-index: ${getComputedStyle(eventLog).zIndex}`);
            } else {
                log('âŒ event-log å…ƒç´ ä¸å­˜åœ¨', 'red');
            }

            // æª¢æŸ¥ gameAPI å…§éƒ¨ç‹€æ…‹
            if (window.gameAPI) {
                log('âœ… gameAPI å­˜åœ¨');

                // å˜—è©¦è¨ªå•å…§éƒ¨å…ƒç´ ï¼ˆå¦‚æœå¯èƒ½ï¼‰
                if (window.gameAPI.test && window.gameAPI.test.checkElements) {
                    try {
                        window.gameAPI.test.checkElements();
                        log('âœ… gameAPI å…§éƒ¨æª¢æŸ¥å®Œæˆ');
                    } catch (error) {
                        log(`âŒ gameAPI å…§éƒ¨æª¢æŸ¥å¤±æ•—: ${error.message}`, 'red');
                    }
                }
            }
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•åŸ·è¡Œ
        window.addEventListener('load', () => {
            log('ğŸŒŸ äº‹ä»¶æµç¨‹èª¿è©¦é é¢å·²è¼‰å…¥', 'lime');

            setTimeout(() => {
                log('ğŸš€ é–‹å§‹è‡ªå‹•èª¿è©¦åºåˆ—...', 'yellow');
                checkElements();

                setTimeout(() => {
                    interceptEventFlow();

                    setTimeout(() => {
                        testGameLogger();

                        setTimeout(() => {
                            testGameAPI();

                            setTimeout(() => {
                                testDirectEventLog();
                                log('âœ… æ‰€æœ‰æ¸¬è©¦å®Œæˆ', 'lime');
                            }, 1000);
                        }, 1000);
                    }, 1000);
                }, 1000);
            }, 1000);
        });
    </script>
</body>
</html>